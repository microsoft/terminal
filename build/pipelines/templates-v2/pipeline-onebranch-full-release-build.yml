parameters:
  - name: official
    type: boolean
    default: false
  - name: branding
    type: string
    default: Release
    values:
      - Release
      - Preview
      - Canary
      - Dev
  - name: buildTerminal
    type: boolean
    default: true
  - name: buildConPTY
    type: boolean
    default: false
  - name: buildWPF
    type: boolean
    default: false
  - name: pgoBuildMode
    type: string
    default: Optimize
    values:
      - Optimize
      - Instrument
      - None
  - name: buildConfigurations
    type: object
    default:
      - Release
  - name: buildPlatforms
    type: object
    default:
      - x64
      - x86
      - arm64
  - name: codeSign
    type: boolean
    default: true
  - name: terminalInternalPackageVersion
    type: string
    default: '0.0.8'

  - name: publishSymbolsToPublic
    type: boolean
    default: true
  - name: symbolExpiryTime
    type: string
    default: 36530 # This is the default from PublishSymbols@2
  - name: publishVpackToWindows
    type: boolean
    default: false
  - name: symbolPublishingSubscription
    type: string
  - name: symbolPublishingProject
    type: string

  - name: extraPublishJobs
    type: object
    default: []
  - name: signingIdentity
    type: object
    default: {}

resources:
  repositories:
  - repository: templates
    type: git
    name: OneBranch.Pipelines/GovernedTemplates
    ref: refs/heads/main

extends:
  ${{ if eq(parameters.official, true) }}:
    template: v2/Microsoft.Official.yml@templates # https://aka.ms/obpipelines/templates
  ${{ else }}:
    template: v2/Microsoft.NonOfficial.yml@templates
  parameters:
    featureFlags:
      WindowsHostVersion:
        Version: 2022
        Network: R1
    platform:
      name: 'windows_undocked'
      product: 'Windows Terminal'
    cloudvault: # https://aka.ms/obpipelines/cloudvault
      enabled: false
    globalSdl: # https://aka.ms/obpipelines/sdl
      enableCheckCFlags: false # CheckCFlags is broken and exploding our builds; to remove, :g/BAD-FLAGS/d
      asyncSdl:
        enabled: true
        tsaOptionsFile: 'build/config/tsa.json'
      tsa:
        enabled: true
        configFile: '$(Build.SourcesDirectory)\build\config\tsa.json'
      binskim:
        break: false
        scanOutputDirectoryOnly: true
      policheck:
        break: false
        severity: Note
      baseline:
        baselineFile: '$(Build.SourcesDirectory)\build\config\release.gdnbaselines'
        suppressionSet: default

    stages:
      - stage: Publish
        displayName: Publish
        jobs:
          - ${{ parameters.extraPublishJobs }}
